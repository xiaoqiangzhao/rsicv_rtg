#!/usr/bin/env python3
"""
Integration test for RISC-V random instruction generator and shader system.

This test demonstrates how to use the Python generator to produce instructions
that can be tested with the C++ shader system.
"""

import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'src'))

import yaml
from riscv_rtg.isa.riscv_isa import RISCVISA, InstructionFormat


def test_instruction_generation():
    """Generate random instructions and verify they match YAML definitions."""
    print("=== RISC-V Instruction Generator ↔ Shader System Integration Test ===")
    print()

    # Load YAML definitions
    yaml_path = os.path.join(os.path.dirname(__file__), '..', 'src', 'riscv_rtg', 'isa', 'definitions', 'rv32i.yaml')
    with open(yaml_path, 'r') as f:
        yaml_data = yaml.safe_load(f)

    print(f"Loaded YAML definitions: {len(yaml_data['instructions'])} instructions")

    # Create ISA instance
    isa = RISCVISA()

    print(f"Python RISCVISA loaded: {len(isa.instructions)} instructions")
    print()

    # Generate some sample instructions
    print("=== Sample Instruction Generation ===")
    for i in range(5):
        encoded, asm = isa.generate_random_instruction()
        print(f"{i+1}. {asm}")
        print(f"   Hex: 0x{encoded:08x}")
        print(f"   Bin: {bin(encoded)[2:].zfill(32)}")
        print()

    # Verify instruction counts match
    yaml_count = len(yaml_data['instructions'])
    python_count = len(isa.instructions)

    if yaml_count == python_count:
        print(f"✅ Instruction counts match: {yaml_count}")
    else:
        print(f"❌ Instruction count mismatch: YAML={yaml_count}, Python={python_count}")

    # Check format distribution
    print()
    print("=== Instruction Format Distribution ===")
    for fmt in InstructionFormat:
        instrs = isa.get_instructions_by_format(fmt)
        if instrs:
            print(f"{fmt.value}-type: {len(instrs)} instructions")

    # Generate test program
    print()
    print("=== Example Test Program (10 instructions) ===")
    print("// Generated by riscv_rtg for shader system testing")
    print("#include <cstdint>")
    print("#include <vector>")
    print()
    print("std::vector<uint32_t> test_program = {")

    instructions = []
    for i in range(10):
        encoded, asm = isa.generate_random_instruction()
        instructions.append((encoded, asm))
        print(f"    0x{encoded:08x},  // {asm}")

    print("};")
    print()
    print(f"// Total: {len(instructions)} instructions")

    # Generate C++ test harness
    print()
    print("=== C++ Test Harness Skeleton ===")
    print("""
// Example of how to use generated instructions in C++ tests
#include "riscv_isa.h"
#include "riscv_isa_generated.h"

void test_generated_instructions() {
    shader_system::RiscvISA riscv_isa;

    for (uint32_t instr_word : test_program) {
        auto decoded = riscv_isa.decodeInstruction(instr_word, 0x1000);

        // Look up metadata
        auto* meta = shader_system::getInstructionMetadata(
            decoded.opcode, decoded.funct3, decoded.funct7);

        if (meta) {
            std::cout << "Decoded: " << meta->mnemonic << std::endl;
        }
    }
}
""")

    return yaml_count == python_count


def verify_opcode_values():
    """Verify that opcode values match C++ header."""
    print()
    print("=== Opcode Value Verification ===")

    # Load YAML enums
    yaml_path = os.path.join(os.path.dirname(__file__), '..', 'src', 'riscv_rtg', 'isa', 'definitions', 'rv32i.yaml')
    with open(yaml_path, 'r') as f:
        yaml_data = yaml.safe_load(f)

    # Known C++ values from riscv_isa.h
    cpp_opcodes = {
        'LOAD': 0b0000011,      # 3
        'STORE': 0b0100011,     # 35
        'OP_IMM': 0b0010011,    # 19
        'OP': 0b0110011,        # 51
        'BRANCH': 0b1100011,    # 99
        'JAL': 0b1101111,       # 111
        'JALR': 0b1100111,      # 103
        'SYSTEM': 0b1110011,    # 115
        'LUI': 0b0110111,       # 55
        'AUIPC': 0b0010111,     # 23
        'FENCE': 0b0001111,     # 15
        'CUSTOM': 0b0001011,    # 11
    }

    all_match = True
    for name, expected_value in cpp_opcodes.items():
        yaml_value = yaml_data['enums']['opcode'].get(name)
        if yaml_value is not None:
            if yaml_value == expected_value:
                print(f"✅ {name}: 0b{yaml_value:07b} (0x{yaml_value:x}, {yaml_value})")
            else:
                print(f"❌ {name}: YAML=0b{yaml_value:07b}, C++=0b{expected_value:07b}")
                all_match = False
        else:
            print(f"⚠️  {name}: Not found in YAML")

    return all_match


if __name__ == '__main__':
    print("RISC-V Random Instruction Generator ↔ Shader System Integration Test")
    print("====================================================================")
    print()

    test1 = test_instruction_generation()
    print()
    test2 = verify_opcode_values()

    print()
    print("=" * 70)
    if test1 and test2:
        print("✅ All integration tests passed!")
        print("The Python generator is ready to produce instructions for shader system testing.")
        sys.exit(0)
    else:
        print("❌ Some integration tests failed.")
        sys.exit(1)